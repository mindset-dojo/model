{%- comment -%}
Renders a single post article.
Inputs:
  include.post
  include.excerpt_length (optional)
  include.hide_practitioner -> when true, skip printing everything except title+link
Notes:
  - Keeps existing slug + practitioners normalization logic to compute practitioner_name_string
  - honor hide_practitioner so grouped-by-practitioner lists can render a practitioner card once
{%- endcomment -%}

{%- assign post = include.item | default: include.post -%}
{%- assign excerpt_len = include.excerpt_length | default: 220 -%}
{%- assign hide_practitioner = include.hide_practitioner | default: false -%}

{%- comment -%} Resolve a safe slug for the post (defensive) {%- endcomment -%}
{% assign post_slug = post.slug %}
{% if post_slug == nil or post_slug == "" %}
  {% assign segments = post.url | split: '/' %}
  {% assign last = segments | last %}
  {% if last == "" %}
    {% assign idx = segments.size | minus: 2 %}
    {% assign post_slug = segments | slice: idx, 1 | first %}
  {% else %}
    {% assign post_slug = last %}
  {% endif %}
{% endif %}
{% if post_slug == nil or post_slug == "" %}
  {% assign post_slug = post.title | slugify %}
{% endif %}

{%- comment -%} Normalize post.practitioners to an array of slugs {%- endcomment -%}
{% assign practitioner_names = "" | split: "," %}
{% assign raw_practitioners = post.practitioners %}
{% assign practitioner_slugs = "" | split: "|" %}

{% if raw_practitioners %}
  {% if raw_practitioners[0] != nil %}
    {% assign practitioner_slugs = raw_practitioners %}
  {% else %}
    {% assign s = raw_practitioners | to_s | strip %}
    {% if s contains '[' and s contains ']' %}
      {% assign s = s | remove:'[' | remove:']' | remove:'"' | remove:"'" | strip %}
      {% assign practitioner_slugs = s | split:',' | map:'strip' %}
    {% elsif s contains ',' %}
      {% assign practitioner_slugs = s | split:',' | map:'strip' %}
    {% else %}
      {% assign practitioner_slugs = s | split:'\n' | map:'strip' %}
    {% endif %}
  {% endif %}
{% endif %}

{%- comment -%} Strict slug-only resolution against site.practitioners collection {%- endcomment -%}
{% for s in practitioner_slugs %}
  {% assign s_norm = s | split:'.' | first | slugify %}
  {% assign doc = site.practitioners | where: "slug", s_norm | first %}
  {% if doc and doc.name %}
    {% assign practitioner_names = practitioner_names | push: doc.name %}
  {% endif %}
{% endfor %}

{%- comment -%} Build display string {%- endcomment -%}
{% assign practitioner_name_string = "" %}
{% if practitioner_names.size == 0 %}
  {% assign practitioner_name_string = site.title %}
{% elsif practitioner_names.size == 1 %}
  {% assign practitioner_name_string = practitioner_names[0] %}
{% else %}
  {% assign last_index = practitioner_names.size | minus: 1 %}
  {% for name in practitioner_names %}
    {% assign practitioner_name_string = practitioner_name_string | append: name %}
    {% unless forloop.index0 == last_index %}
      {% assign practitioner_name_string = practitioner_name_string | append: " and " %}
    {% endunless %}
  {% endfor %}
{% endif %}


<article class="collection-item" itemscope itemtype="https://schema.org/Article">
  <hr>
  <h3 class="title"><a href="{{ post.url | relative_url }}">{{ post.title }}</a></h3>
  <p class="meta">
      By {{ practitioner_name_string | default: site.title }} â€” {{ post.published_date | date: "%b %-d, %Y" }}
  </p>
  <p class="excerpt">
      {{ post.excerpt | default: post.content | strip_html | truncate: excerpt_len }}
  </p>
</article>
