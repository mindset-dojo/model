{%- comment -%}
Reusable card grid wrapper. Accepts:
  items: array of documents to render
  item_partial: include path to render each card
  initial_limit: hide cards beyond this index (for Show All)
  total_count: size of the full list (defaults to items.size)
  wrapper_class: optional extra classes on the grid container
  item: optional single item to render (when not providing an array)
{%- endcomment -%}

{%- assign items = include.items -%}
{%- assign single_item = include.item -%}
{%- assign item_partial = include.item_partial | default: "sections/collection-item.html" -%}
{%- assign initial_limit = include.initial_limit | default: nil -%}
{%- assign total_count = include.total_count | default: nil -%}
{%- assign grid_class = "card-stream-grid" -%}
{%- if include.wrapper_class and include.wrapper_class != "" -%}
  {%- assign grid_class = grid_class | append: " " | append: include.wrapper_class -%}
{%- endif -%}

{%- assign items_array = nil -%}
{%- if single_item -%}
  {%- assign items_array = "" | split:"|" | push: single_item -%}
  {%- assign total_items = total_count | default: 1 -%}
{%- else -%}
  {%- assign items_array = items | array -%}
  {%- assign total_items = total_count | default: items_array | size -%}
{%- endif -%}

{%- if total_items == 1 -%}
  {%- assign grid_class = grid_class | append: " card-grid-single" -%}
{%- elsif total_items == 2 -%}
  {%- assign grid_class = grid_class | append: " card-grid-double" -%}
{%- endif -%}

{%- if items_array and items_array != empty -%}
  {%- assign visible_count = 0 -%}
  {%- for item in items_array -%}
    {%- assign hide_item = false -%}
    {%- if initial_limit and total_items > initial_limit and forloop.index0 >= initial_limit -%}
      {%- assign hide_item = true -%}
    {%- endif -%}
    {%- if hide_item == false -%}
      {%- assign visible_count = visible_count | plus: 1 -%}
    {%- endif -%}
  {%- endfor -%}
  <div class="{{ grid_class }}" data-card-grid data-visible-items="{{ visible_count }}">
    {%- for item in items_array -%}
      {%- assign hide_item = false -%}
      {%- if initial_limit and total_items > initial_limit and forloop.index0 >= initial_limit -%}
        {%- assign hide_item = true -%}
      {%- endif -%}
      {%- assign filter_value = "" -%}
      {%- if include.item_filter_values -%}
        {%- assign override_value = include.item_filter_values[forloop.index0] -%}
        {%- if override_value -%}
          {%- assign filter_value = override_value | downcase -%}
        {%- endif -%}
      {%- endif -%}
      {%- if filter_value == "" -%}
        {%- assign tag_list = item.tags | array -%}
        {%- if tag_list and tag_list != empty -%}
          {%- assign filter_value = tag_list | join: ' ' | downcase -%}
        {%- endif -%}
      {%- endif -%}
      <div class="collection-stream-item card-stream-item{% if hide_item %} is-hidden{% endif %}"
           data-collection-item
           data-card-item
           data-tags="{{ filter_value }}">
        {%- case item_partial -%}
          {%- when "sections/practice-card.html" -%}
            {% include sections/practice-card.html item=item post=item %}
          {%- when "sections/area-card.html" -%}
            {% include sections/area-card.html item=item post=item %}
          {%- when "sections/practitioner.html" -%}
            {% include sections/practitioner.html item=item practitioner=item %}
          {%- when "sections/level-card.html" -%}
            {% include sections/level-card.html item=item level=item %}
          {%- else -%}
            {% include sections/collection-item.html item=item post=item %}
        {%- endcase -%}
      </div>
    {%- endfor -%}
  </div>
{%- endif -%}
